<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>World Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --fg: #f8fafc;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
        background: linear-gradient(135deg, #0f172a, #1d4ed8);
        color: var(--fg);
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1.5rem;
        text-align: center;
      }

      h1 {
        font-weight: 600;
        letter-spacing: 0.04em;
        margin: 0.2rem 0 0.5rem;
      }

      p {
        margin: 0;
        opacity: 0.8;
      }

      #country-info {
        font-size: 0.95rem;
        letter-spacing: 0.02em;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      #country-info.active {
        opacity: 1;
        transform: translateY(-2px);
        color: #fcd34d;
      }

      main {
        flex: 1;
        padding: 0 1.5rem 1.5rem;
      }

      #map {
        width: 100%;
        height: calc(100vh - 180px);
        min-height: 420px;
        border-radius: 1rem;
        box-shadow: 0 40px 80px rgba(15, 23, 42, 0.35);
        overflow: hidden;
      }

      @media (max-width: 600px) {
        header {
          padding: 1.25rem;
        }

        main {
          padding: 0 1rem 1rem;
        }

        #map {
          height: calc(100vh - 220px);
        }
      }

      .collab-panel {
        position: fixed;
        top: 15.5rem;
        left: 8rem;
        width: 320px;
        max-height: calc(100vh - 9rem);
        background: rgba(15, 23, 42, 0.96);
        border-radius: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.6);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
        padding: 0.9rem 1rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 500;
      }

      .collab-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        cursor: move;
        user-select: none;
      }

      .collab-panel-header h2 {
        margin: 0;
        font-size: 0.95rem;
        flex: 1;
      }

      .collab-panel-close {
        background: transparent;
        border: none;
        color: #e5e7eb;
        cursor: pointer;
        border-radius: 999px;
        width: 1.6rem;
        height: 1.6rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
        transition: transform 0.2s ease;
      }

      .collab-panel.collapsed .collab-panel-close {
        transform: rotate(180deg);
      }

      .collab-panel.collapsed .collab-panel-summary,
      .collab-panel.collapsed .collab-popup-list {
        display: none;
      }

      .collab-panel.dragging {
        cursor: move;
      }

      .collab-panel.dragging * {
        pointer-events: none;
      }

      .collab-panel-close:hover {
        background: rgba(248, 250, 252, 0.12);
      }

      .collab-panel-summary {
        margin: 0;
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .collab-panel .collab-popup-list {
        flex: 1;
      }

      @media (max-width: 900px) {
        .collab-panel {
          position: fixed;
          bottom: 1rem;
          top: auto;
          left: 1rem;
          right: 1rem;
          width: auto;
          max-height: 260px;
        }

        .leaflet-control-attribution {
          position: fixed !important;
          bottom: 0.5rem !important;
          left: 1rem !important;
          right: auto !important;
          margin: 0 !important;
          font-size: 0.7rem;
          z-index: 400;
        }
      }

      .collab-tooltip {
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(248, 250, 252, 0.2);
        border-radius: 0.5rem;
        padding: 0.4rem 0.75rem;
        color: #f8fafc;
        font-size: 0.85rem;
        font-weight: 500;
        box-shadow: 0 10px 25px rgba(2, 6, 23, 0.35);
      }

      .collab-tooltip:before {
        border-top-color: rgba(15, 23, 42, 0.92);
      }

      .collab-popup {
        max-width: 260px;
        color: #e5e7eb;
      }

      .collab-popup h3 {
        margin: 0 0 0.35rem;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .collab-popup p {
        margin: 0 0 0.4rem;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      .collab-popup-list {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.1rem;
      }

      .collab-popup-list ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .collab-popup-list li.institution-item {
        background: transparent;
        padding: 0;
        border: none;
        cursor: default;
      }

      .collab-popup-list li.institution-item:hover {
        background: transparent;
      }

      .collab-link {
        align-self: center;
        text-decoration: none;
        border: 1px solid rgba(248, 250, 252, 0.4);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.72rem;
        color: #f8fafc;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .collab-link:hover {
        background: rgba(248, 250, 252, 0.2);
        color: #fcd34d;
      }

      .institution-item {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 0.45rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        margin-bottom: 0.5rem;
        overflow: hidden;
        transition: border-color 0.2s ease;
      }

      .institution-item:hover {
        border-color: rgba(14, 165, 233, 0.6);
      }

      .institution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.6rem;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }

      .institution-header:hover {
        background: rgba(14, 165, 233, 0.1);
      }

      .institution-header-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .institution-name {
        font-weight: 600;
        font-size: 0.8rem;
        color: #f8fafc;
      }

      .institution-count {
        font-size: 0.7rem;
        color: #9ca3af;
      }

      .institution-toggle {
        background: transparent;
        border: 1px solid rgba(248, 250, 252, 0.3);
        color: #f8fafc;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .institution-toggle:hover {
        background: rgba(248, 250, 252, 0.1);
        border-color: rgba(248, 250, 252, 0.5);
      }

      .institution-datasets {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: rgba(15, 23, 42, 0.95);
      }

      .institution-item.expanded .institution-datasets {
        max-height: 1000px;
      }

      .institution-item.expanded .institution-toggle {
        transform: rotate(90deg);
      }

      .dataset-item {
        padding: 0.4rem 0.6rem 0.4rem 1.2rem;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
        transition: background 0.2s ease;
      }

      .collab-panel-list.show-all-datasets > .dataset-item:first-child {
        border-top: none;
      }

      .collab-panel-list.show-all-datasets > .dataset-item {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 0.45rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        margin-bottom: 0.5rem;
        padding-left: 0.6rem;
      }

      .collab-panel-list.show-all-datasets > .dataset-item:hover {
        border-color: rgba(14, 165, 233, 0.6);
      }

      .dataset-item:hover {
        background: rgba(14, 165, 233, 0.1);
      }

      .dataset-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .dataset-title {
        font-size: 0.75rem;
        color: #e5e7eb;
        line-height: 1.3;
      }

      .dataset-year {
        font-size: 0.7rem;
        color: #9ca3af;
      }

      .dataset-view-btn {
        align-self: flex-start;
        text-decoration: none;
        border: 1px solid rgba(248, 250, 252, 0.4);
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        font-size: 0.7rem;
        color: #f8fafc;
        transition: background 0.2s ease, color 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .dataset-view-btn:hover {
        background: rgba(248, 250, 252, 0.2);
        color: #fcd34d;
      }
    </style>
  </head>
  <body>
    <header>
      <small>FAIR Project · Explorer</small>
      <h1>World Map Overview</h1>
      <p id="country-info">Pan and zoom to explore any region on Earth.</p>
    </header>
    <main>
      <div id="map" role="region" aria-label="Interactive world map"></div>
      <aside id="collab-panel" class="collab-panel">
        <div class="collab-panel-header">
          <h2 id="collab-panel-title">Collaborations</h2>
          <button
            id="collab-panel-close"
            class="collab-panel-close"
            type="button"
            aria-label="Toggle collaboration panel"
          >
            ▼
          </button>
        </div>
        <p id="collab-panel-summary" class="collab-panel-summary"></p>
        <div class="collab-popup-list">
          <ul id="collab-panel-list"></ul>
        </div>
      </aside>
    </main>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const map = L.map("map", {
        worldCopyJump: true,
        zoomControl: true,
        attributionControl: true,
      }).setView([20, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 6,
        minZoom: 2,
        attribution:
          'Map data © <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Map from ISO country code to display name and coordinates
      // This will be populated from all_country_codes.csv
      let COUNTRY_META = {};

      // Load country codes from CSV and build COUNTRY_META
      function loadCountryMeta() {
        return fetch("data/all_country_codes.csv")
          .then((response) => response.text())
          .then((csvText) => {
            const lines = csvText.trim().split("\n");
            if (lines.length < 2) return; // Need at least header + one data row
            
            const headers = lines[0].split(",").map((h) => h.trim());
            
            // Find column indices
            const countryIdx = headers.indexOf("country");
            const nameIdx = headers.indexOf("name");
            const latIdx = headers.indexOf("latitude");
            const lngIdx = headers.indexOf("longitude");

            if (countryIdx === -1 || nameIdx === -1 || latIdx === -1 || lngIdx === -1) {
              console.error("Missing required columns in country codes CSV");
              return;
            }

            // Parse CSV and build COUNTRY_META
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;

              // Simple CSV parsing - split by comma, handle quoted fields
              const values = [];
              let current = "";
              let inQuotes = false;
              
              for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === "," && !inQuotes) {
                  values.push(current.trim());
                  current = "";
                } else {
                  current += char;
                }
              }
              values.push(current.trim());

              if (values.length > Math.max(countryIdx, nameIdx, latIdx, lngIdx)) {
                const code = values[countryIdx]?.trim();
                const name = values[nameIdx]?.trim();
                const lat = parseFloat(values[latIdx]);
                const lng = parseFloat(values[lngIdx]);

                if (code && name && !isNaN(lat) && !isNaN(lng)) {
                  COUNTRY_META[code] = {
                    name: name,
                    coords: [lat, lng], // Leaflet format: [latitude, longitude]
                  };
                }
              }
            }
          })
          .catch((error) => {
            console.error("Failed to load country codes:", error);
            // Fallback to empty object - countryMetaFromCode will handle missing codes
          });
      }

      function countryMetaFromCode(code) {
        if (COUNTRY_META[code]) return COUNTRY_META[code];
        return {
          name: code,
          coords: [20, 0],
        };
      }

      const infoPanel = document.getElementById("country-info");
      const defaultInfo = infoPanel.textContent;

      const collabPanel = document.getElementById("collab-panel");
      const collabPanelTitle = document.getElementById("collab-panel-title");
      const collabPanelSummary = document.getElementById("collab-panel-summary");
      const collabPanelList = document.getElementById("collab-panel-list");
      const collabPanelClose = document.getElementById("collab-panel-close");

      // Base styles for circles
      const baseCircleStyle = {
        color: "#22d3ee",
        weight: 2,
        fillColor: "#0ea5e9",
        fillOpacity: 0.35,
      };

      const hoverCircleStyle = {
        color: "#f97316",
        weight: 3,
        fillColor: "#f59e0b",
        fillOpacity: 0.55,
      };

      // Store all created circles so we can resize them on zoom
      // and cross-link them to collaborations.
      const countryCircles = [];
      const circlesByCountry = {};
      const datasetToCountries = {};
      let datasetHighlightActive = null;
      let datasetHighlightedCircles = [];

      // Compute a circle radius (in pixels) based on collaboration "size" and current zoom.
      // More zoom => smaller circles, to reduce overlap when zoomed into dense regions.
      function radiusForZoom(sizeScale, zoom) {
        const MIN_RADIUS = 10; // baseline minimum size in pixels
        const MAX_RADIUS = 40; // maximum size in pixels at world view

        const baseRadius = MIN_RADIUS + sizeScale * (MAX_RADIUS - MIN_RADIUS);

        // As zoom increases above 2, shrink the radius.
        // You can tweak the 0.25 factor to make shrinking stronger/weaker.
        const zoomFactor = 1 + Math.max(0, zoom - 2) * 0.25;

        return Math.max(MIN_RADIUS, baseRadius / zoomFactor);
      }

      function clearDatasetHighlight() {
        if (!datasetHighlightActive) return;
        datasetHighlightedCircles.forEach((c) => c.setStyle(baseCircleStyle));
        datasetHighlightActive = null;
        datasetHighlightedCircles = [];
      }

      function highlightDataset(datasetId) {
        if (!datasetId) return;
        // Reset any previous highlight
        clearDatasetHighlight();

        const countries = datasetToCountries[datasetId];
        if (!countries) return;

        const newlyHighlighted = [];
        countries.forEach((cc) => {
          const circles = circlesByCountry[cc] || [];
          circles.forEach((circle) => {
            circle.setStyle(hoverCircleStyle);
            newlyHighlighted.push(circle);
          });
        });

        datasetHighlightActive = datasetId;
        datasetHighlightedCircles = newlyHighlighted;
      }

      function wireDatasetHoverHandlers(container) {
        if (!container) return;
        const items = container.querySelectorAll(".dataset-item[data-dataset-id]");
        items.forEach((item) => {
          const datasetId = item.getAttribute("data-dataset-id");
          if (!datasetId) return;

          item.addEventListener("mouseenter", () => {
            highlightDataset(datasetId);
          });

          item.addEventListener("mouseleave", () => {
            clearDatasetHighlight();
          });
        });
      }

      function showCountryCollaborations(meta, data) {
        collabPanel.hidden = false;
        collabPanel.classList.remove("collapsed");
        collabPanelClose.setAttribute("aria-label", "Collapse collaboration panel");
        const isAllDatasets = meta.name === "Politecnico di Torino";
        
        if (isAllDatasets) {
          collabPanelTitle.textContent = "All Politecnico di Torino Datasets";
        } else {
          collabPanelTitle.textContent = `${meta.name} collaborations`;
        }

        if (data.length) {
          if (isAllDatasets) {
            const soloCount = data.filter(d => d.partner === "Politecnico di Torino only").length;
            const collabCount = data.length - soloCount;
            collabPanelSummary.textContent = `${data.length} total dataset${
              data.length === 1 ? "" : "s"
            } (${collabCount} collaboration${collabCount === 1 ? "" : "s"}, ${soloCount} solo Politecnico${soloCount === 1 ? "" : ""}).`;
          } else {
            collabPanelSummary.textContent = `${data.length} dataset collaboration${
              data.length === 1 ? "" : "s"
            } with Politecnico di Torino.`;
          }
        } else {
          collabPanelSummary.textContent = "No datasets recorded yet.";
        }

        collabPanelList.innerHTML = "";
        
        // Add class to indicate all datasets view (no grouping)
        if (isAllDatasets) {
          collabPanelList.classList.add("show-all-datasets");
        } else {
          collabPanelList.classList.remove("show-all-datasets");
        }

        if (!data.length) {
          clearDatasetHighlight();
          return;
        }

        // For Politecnico all datasets view, show datasets directly without grouping
        if (isAllDatasets) {
          // Sort datasets by year (descending), then by title
          const sortedData = [...data].sort((a, b) => {
            const yearA = a.year || 0;
            const yearB = b.year || 0;
            if (yearB !== yearA) return yearB - yearA;
            return (a.title || "").localeCompare(b.title || "");
          });

          sortedData.forEach((item) => {
            const url = item.dataset_id || "";
            const title = item.title || "Dataset";
            const year = item.year || "";

            const datasetItem = document.createElement("li");
            datasetItem.className = "dataset-item";
            datasetItem.setAttribute("data-dataset-id", url);
            
            const datasetContent = document.createElement("div");
            datasetContent.className = "dataset-content";
            
            const datasetTitle = document.createElement("div");
            datasetTitle.className = "dataset-title";
            datasetTitle.textContent = title;
            
            const datasetYear = document.createElement("div");
            datasetYear.className = "dataset-year";
            datasetYear.textContent = year;
            
            datasetContent.appendChild(datasetTitle);
            if (year) {
              datasetContent.appendChild(datasetYear);
            }
            
            const viewBtn = document.createElement("a");
            if (url) {
              viewBtn.href = url;
              viewBtn.target = "_blank";
              viewBtn.rel = "noopener noreferrer";
              viewBtn.className = "dataset-view-btn";
              viewBtn.textContent = "View";
            }
            
            datasetItem.appendChild(datasetContent);
            if (url) {
              datasetItem.appendChild(viewBtn);
            }
            
            collabPanelList.appendChild(datasetItem);
          });
        } else {
          // Group collaborations by institution/partner for country views
          const institutionsMap = {};
          data.forEach((item) => {
            const partner = item.partner || "Unknown partner";
            if (!institutionsMap[partner]) {
              institutionsMap[partner] = [];
            }
            institutionsMap[partner].push(item);
          });

          // Create UI for each institution
          Object.keys(institutionsMap).sort().forEach((partner) => {
            const datasets = institutionsMap[partner];
            const datasetCount = datasets.length;

            const institutionItem = document.createElement("li");
            institutionItem.className = "institution-item";
            
            const institutionHeader = document.createElement("div");
            institutionHeader.className = "institution-header";
            
            const headerContent = document.createElement("div");
            headerContent.className = "institution-header-content";
            
            const institutionName = document.createElement("div");
            institutionName.className = "institution-name";
            institutionName.textContent = partner;
            
            const institutionCount = document.createElement("div");
            institutionCount.className = "institution-count";
            institutionCount.textContent = `${datasetCount} dataset${datasetCount === 1 ? "" : "s"}`;
            
            headerContent.appendChild(institutionName);
            headerContent.appendChild(institutionCount);
            
            const toggleBtn = document.createElement("button");
            toggleBtn.className = "institution-toggle";
            toggleBtn.textContent = "›";
            toggleBtn.setAttribute("aria-label", `Toggle ${partner} datasets`);
            
            institutionHeader.appendChild(headerContent);
            institutionHeader.appendChild(toggleBtn);
            
            const datasetsContainer = document.createElement("div");
            datasetsContainer.className = "institution-datasets";
            
            const datasetsList = document.createElement("ul");
            datasetsList.style.listStyle = "none";
            datasetsList.style.margin = "0";
            datasetsList.style.padding = "0";
            
            datasets.forEach((item) => {
              const url = item.dataset_id || "";
              const title = item.title || "Dataset";
              const year = item.year || "";

              const datasetItem = document.createElement("li");
              datasetItem.className = "dataset-item";
              datasetItem.setAttribute("data-dataset-id", url);
              
              const datasetContent = document.createElement("div");
              datasetContent.className = "dataset-content";
              
              const datasetTitle = document.createElement("div");
              datasetTitle.className = "dataset-title";
              datasetTitle.textContent = title;
              
              const datasetYear = document.createElement("div");
              datasetYear.className = "dataset-year";
              datasetYear.textContent = year;
              
              datasetContent.appendChild(datasetTitle);
              if (year) {
                datasetContent.appendChild(datasetYear);
              }
              
              const viewBtn = document.createElement("a");
              if (url) {
                viewBtn.href = url;
                viewBtn.target = "_blank";
                viewBtn.rel = "noopener noreferrer";
                viewBtn.className = "dataset-view-btn";
                viewBtn.textContent = "View";
              }
              
              datasetItem.appendChild(datasetContent);
              if (url) {
                datasetItem.appendChild(viewBtn);
              }
              
              datasetsList.appendChild(datasetItem);
            });
            
            datasetsContainer.appendChild(datasetsList);
            
            institutionItem.appendChild(institutionHeader);
            institutionItem.appendChild(datasetsContainer);
            
            // Toggle expand/collapse on header click
            institutionHeader.addEventListener("click", () => {
              institutionItem.classList.toggle("expanded");
            });
            
            collabPanelList.appendChild(institutionItem);
          });
        }

        wireDatasetHoverHandlers(collabPanelList);
      }

      collabPanelClose.addEventListener("click", () => {
        collabPanel.classList.toggle("collapsed");
        const isCollapsed = collabPanel.classList.contains("collapsed");
        collabPanelClose.setAttribute("aria-label", isCollapsed ? "Expand collaboration panel" : "Collapse collaboration panel");
        if (isCollapsed) {
          clearDatasetHighlight();
        }
      });

      // Make the panel draggable via the header
      const collabPanelHeader = collabPanel.querySelector(".collab-panel-header");
      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let panelStartX = 0;
      let panelStartY = 0;

      collabPanelHeader.addEventListener("mousedown", (e) => {
        // Don't start dragging if clicking the close button
        if (e.target === collabPanelClose || collabPanelClose.contains(e.target)) {
          return;
        }

        isDragging = true;
        collabPanel.classList.add("dragging");

        // Get initial mouse position
        dragStartX = e.clientX;
        dragStartY = e.clientY;

        // Get initial panel position
        const rect = collabPanel.getBoundingClientRect();
        panelStartX = rect.left;
        panelStartY = rect.top;

        e.preventDefault();
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;

        // Calculate new position
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;

        const newX = panelStartX + deltaX;
        const newY = panelStartY + deltaY;

        // Constrain to viewport bounds
        const maxX = window.innerWidth - collabPanel.offsetWidth;
        const maxY = window.innerHeight - collabPanel.offsetHeight;

        const constrainedX = Math.max(0, Math.min(newX, maxX));
        const constrainedY = Math.max(0, Math.min(newY, maxY));

        collabPanel.style.left = `${constrainedX}px`;
        collabPanel.style.top = `${constrainedY}px`;
        collabPanel.style.right = "auto";
      });

      document.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          collabPanel.classList.remove("dragging");
        }
      });

      // Create a custom icon for Turin marker using the position image
      const turinIcon = L.icon({
        iconUrl: "assets/position-12.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32],
      });

      // Turin coordinates
      const TURIN_COORDS = [45.0703, 7.6868];

      // Function to load all datasets including solo Politecnico ones
      function loadAllDatasets() {
        // First, collect all datasets from collaborations
        const allDatasetsMap = new Map();
        
        // We'll fetch collaborations.json and also try to fetch all_datasets.json if available
        return Promise.all([
          fetch("data/collaborations.json").then((r) => r.json()).catch(() => []),
          fetch("data/all_datasets.json").then((r) => r.json()).catch(() => null),
        ]).then(([collaborations, allDatasets]) => {
          // Collect all unique datasets from collaborations
          collaborations.forEach((country) => {
            (country.collaborations || []).forEach((collab) => {
              const id = collab.dataset_id;
              if (id && !allDatasetsMap.has(id)) {
                allDatasetsMap.set(id, {
                  dataset_id: id,
                  title: collab.title,
                  year: collab.year,
                  partner: collab.partner,
                });
              }
            });
          });

          // If all_datasets.json exists, add solo Politecnico datasets
          if (allDatasets && Array.isArray(allDatasets)) {
            allDatasets.forEach((dataset) => {
              const id = dataset.dataset_id;
              if (id && !allDatasetsMap.has(id)) {
                // This dataset is not in collaborations, so it's solo Politecnico
                allDatasetsMap.set(id, {
                  dataset_id: id,
                  title: dataset.title,
                  year: dataset.year,
                  partner: "Politecnico di Torino only",
                });
              }
            });
          }

          return Array.from(allDatasetsMap.values());
        });
      }

      // Function to show all datasets in the collaboration panel
      function showAllDatasets() {
        loadAllDatasets().then((allDatasets) => {
          const meta = { name: "Politecnico di Torino" };
          showCountryCollaborations(meta, allDatasets);
        }).catch(() => {
          // Fallback: show only collaboration datasets
          fetch("data/collaborations.json")
            .then((resp) => resp.json())
            .then((countries) => {
              const allCollabDatasets = [];
              countries.forEach((country) => {
                (country.collaborations || []).forEach((collab) => {
                  allCollabDatasets.push(collab);
                });
              });
              const meta = { name: "Politecnico di Torino" };
              showCountryCollaborations(meta, allCollabDatasets);
            });
        });
      }

      // Add Turin marker
      const turinMarker = L.marker(TURIN_COORDS, { icon: turinIcon })
        .addTo(map)
        .bindTooltip(
          "<strong>Politecnico di Torino</strong><br/>Click to view all datasets",
          {
            direction: "top",
            offset: [0, -10],
            sticky: true,
            opacity: 1,
            className: "collab-tooltip",
          }
        );

      turinMarker.on("click", () => {
        showAllDatasets();
      });

      turinMarker.on("mouseover", () => {
        infoPanel.textContent = "Politecnico di Torino: Click to view all datasets";
        infoPanel.classList.add("active");
        turinMarker.openTooltip();
      });

      turinMarker.on("mouseout", () => {
        infoPanel.textContent = defaultInfo;
        infoPanel.classList.remove("active");
        turinMarker.closeTooltip();
      });

      // Load country metadata first, then load collaborations
      loadCountryMeta()
        .then(() => {
          // Load real collaborations derived from polito_works.json
          return fetch("data/collaborations.json").then((resp) => resp.json());
        })
        .then((countries) => {
          if (!Array.isArray(countries) || countries.length === 0) {
            infoPanel.textContent = "No collaborations found – run the data pipeline first.";
            return;
          }

          const maxCollaborations = Math.max(
            ...countries.map((c) => c.collaborations_count || 0)
          );

          // Build a map from dataset_id to all country codes involved in that dataset
          countries.forEach((entry) => {
            const cc = entry.country_code;
            (entry.collaborations || []).forEach((item) => {
              const id = item.dataset_id;
              if (!id) return;
              if (!datasetToCountries[id]) {
                datasetToCountries[id] = new Set();
              }
              datasetToCountries[id].add(cc);
            });
          });

          countries.forEach((entry) => {
            // Use country info from entry if available (enriched by build_collaborations.py),
            // otherwise fall back to COUNTRY_META
            let meta;
            if (entry.country && entry.country.coords && entry.country.coords.length === 2) {
              meta = {
                name: entry.country.name || entry.country_code,
                coords: entry.country.coords, // Already in [lat, lng] format
              };
            } else {
              meta = countryMetaFromCode(entry.country_code);
            }
            
            const collabCount = entry.collaborations_count || 0;
            if (!collabCount) return;

            const sizeScale = collabCount / maxCollaborations;

            // Use a circleMarker whose size is expressed in pixels (not meters)
            // so we can dynamically adapt it on map zoom events.
            const circle = L.circleMarker(meta.coords, {
              radius: 0, // will be set after we know the map zoom
              ...baseCircleStyle,
            })
              .bindTooltip(
                `<strong>${meta.name}</strong><br/>${collabCount} collaboration${
                  collabCount === 1 ? "" : "s"
                }`,
                {
                  direction: "top",
                  offset: [0, -10],
                  sticky: true,
                  opacity: 1,
                  className: "collab-tooltip",
                }
              )
              .addTo(map);

            // Remember this circle so we can update its size on zoom
            countryCircles.push({ circle, sizeScale, countryCode: entry.country_code });

            if (!circlesByCountry[entry.country_code]) {
              circlesByCountry[entry.country_code] = [];
            }
            circlesByCountry[entry.country_code].push(circle);

            circle.on("mouseover", () => {
              circle.setStyle(hoverCircleStyle);
              infoPanel.textContent = `${meta.name}: ${collabCount} collaboration${
                collabCount === 1 ? "" : "s"
              }`;
              infoPanel.classList.add("active");
              circle.openTooltip();
            });

            circle.on("mouseout", () => {
              circle.setStyle(baseCircleStyle);
              infoPanel.textContent = defaultInfo;
              infoPanel.classList.remove("active");
              circle.closeTooltip();
            });

            circle.on("click", () => {
              const data = entry.collaborations || [];
              showCountryCollaborations(meta, data);
            });
          });

          // After all circles are created, set their initial radius based on the current zoom
          function updateCircleSizes() {
            const zoom = map.getZoom();
            countryCircles.forEach(({ circle, sizeScale }) => {
              circle.setRadius(radiusForZoom(sizeScale, zoom));
            });
          }

          map.on("zoomend", updateCircleSizes);
          updateCircleSizes();

          // Show all datasets in the collaboration panel on page load
          showAllDatasets();
        })
        .catch(() => {
          infoPanel.textContent = "Failed to load collaboration data.";
        });
    </script>
  </body>
</html>

